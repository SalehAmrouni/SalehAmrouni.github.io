<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Student Atlas - Opportunity Directory</title>
    
    <!-- Pre-initialization: Apply saved accessibility settings before page renders -->
    <script>
        (function() {
            // Load saved theme and accessibility settings immediately
            const savedTheme = localStorage.getItem('studentAtlasTheme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
            
            // Load saved accessibility settings
            const savedAccessibility = localStorage.getItem('studentAtlasAccessibility');
            if (savedAccessibility) {
                try {
                    const accessibility = JSON.parse(savedAccessibility);
                    const html = document.documentElement;
                    
                    // Apply font size
                    if (accessibility.fontSize === 'large') {
                        html.classList.add('large-text');
                    } else if (accessibility.fontSize === 'extra-large') {
                        html.classList.add('extra-large-text');
                    }
                    
                    // Apply high contrast
                    if (accessibility.highContrast) {
                        html.classList.add('high-contrast');
                    }
                    
                    // Apply color blind modes
                    if (accessibility.colorBlindMode && accessibility.colorBlindMode !== 'normal') {
                        html.classList.add(accessibility.colorBlindMode);
                    }
                    
                    // Apply dyslexia friendly
                    if (accessibility.dyslexiaFriendly) {
                        html.classList.add('dyslexia-friendly');
                    }
                    
                    // Apply reduced motion
                    if (accessibility.reducedMotion) {
                        html.classList.add('reduced-motion');
                    }
                } catch (e) {
                    console.log('Could not parse saved accessibility settings');
                }
            }
        })();
    </script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- CSS Files -->
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/accessibility.css">
    
    <meta name="description" content="Student Atlas Dashboard - Interactive directory of 80+ STEM, Arts, Humanitarian, Civics, and Scholarship opportunities with AI-powered filtering.">
</head>
<body>
    <!-- Skip to Content Link -->
    <a href="#main-content" class="skip-to-content">Skip to main content</a>

    <!-- ========== ACCESSIBILITY CONTROLS ========== -->
    <div class="accessibility-bar" id="accessibilityBar">
        <button class="accessibility-btn" id="fontIncrease" aria-label="Increase font size">
            <i data-lucide="zoom-in"></i> A+
        </button>
        <button class="accessibility-btn" id="fontDecrease" aria-label="Decrease font size">
            <i data-lucide="zoom-out"></i> A-
        </button>
        <button class="accessibility-btn" id="highContrast" aria-label="Toggle high contrast mode">
            <i data-lucide="sun"></i> Contrast
        </button>
        <button class="accessibility-btn" id="themeToggle" aria-label="Toggle light/dark theme">
            <i data-lucide="moon"></i> Theme
        </button>
        <button class="accessibility-btn" id="screenReader" aria-label="Enable screen reader mode">
            <i data-lucide="headphones"></i> Reader
        </button>
        <select class="accessibility-btn" id="colorBlindMode" aria-label="Color blind modes">
            <option value="normal">Normal Vision</option>
            <option value="protanopia">Protanopia</option>
            <option value="deuteranopia">Deuteranopia</option>
            <option value="tritanopia">Tritanopia</option>
            <option value="grayscale">Grayscale</option>
        </select>
    </div>

    <!-- ========== GLOBAL HEADER ========== -->
    <header class="global-header">
        <div class="logo" onclick="window.location.href='index.html'">
            <i data-lucide="map" class="logo-icon"></i>
            <h1>Student Atlas</h1>
        </div>
        
        <div class="nav-right">
            <!-- App Navigation -->
            <div id="appNav">
                <button class="btn btn-secondary" onclick="window.location.href='dashboard.html'">
                    <i data-lucide="layout-grid"></i> Directory
                </button>
                <div class="profile-dropdown">
                    <button class="btn btn-secondary" onclick="toggleProfileMenu()">
                        <i data-lucide="user"></i>
                        <span id="userName">Loading...</span>
                        <i data-lucide="chevron-down"></i>
                    </button>
                    <div class="profile-menu hidden" id="profileMenu">
                        <a href="profile.html#profile" class="profile-menu-item">
                            <i data-lucide="id-card"></i>
                            <span>My Profile</span>
                        </a>
                        <a href="profile.html#bookmarks" class="profile-menu-item">
                            <i data-lucide="bookmark"></i>
                            <span>My Bookmarks</span>
                        </a>
                        <a href="profile.html#credentials" class="profile-menu-item">
                            <i data-lucide="key"></i>
                            <span>Credentials</span>
                        </a>
                        <a href="submission.html" class="profile-menu-item">
                            <i data-lucide="plus-circle"></i>
                            <span>Add an Ally</span>
                        </a>
                        <div class="profile-menu-item" onclick="logout()">
                            <i data-lucide="log-out"></i>
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ========== MAIN DASHBOARD CONTENT (3 COLUMNS) ========== -->
    <main id="main-content" class="dashboard-page">
        <!-- ========== LEFT SIDEBAR WITH FILTERS ========== -->
        <aside class="sidebar">
            <!-- Student Profile Summary -->
            <div class="profile-summary">
                <h4 class="flex items-center gap-2">
                    <i data-lucide="user"></i> My Blueprint
                </h4>
                <div class="mt-2">
                    <div class="flex justify-between mb-1">
                        <span class="text-dim">Cluster:</span>
                        <span class="font-bold" id="sidebarCluster">STEM</span>
                    </div>
                    <div class="flex justify-between mb-1">
                        <span class="text-dim">GPA:</span>
                        <span class="font-bold" id="sidebarGPA">3.8</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-dim">Grade:</span>
                        <span class="font-bold" id="sidebarGrade">11th</span>
                    </div>
                </div>
                <button class="btn btn-secondary btn-full mt-3" onclick="window.location.href='profile.html'">
                    <i data-lucide="edit"></i> Edit Profile
                </button>
            </div>

            <!-- Smart Filters -->
            <h3 class="flex items-center gap-2">
                <i data-lucide="filter"></i> Smart Filters
            </h3>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i data-lucide="tag"></i> Cluster
                </label>
                <select class="filter-select" id="filterCluster">
                    <option value="all">All Clusters</option>
                    <option value="STEM">STEM</option>
                    <option value="Arts">Arts</option>
                    <option value="Humanitarian">Humanitarian</option>
                    <option value="Civics">Civics</option>
                    <option value="Scholarships">Scholarships</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i data-lucide="dollar-sign"></i> Cost
                </label>
                <select class="filter-select" id="filterCost">
                    <option value="all">Any Cost</option>
                    <option value="Free">Free</option>
                    <option value="Paid">Paid</option>
                    <option value="Scholarship">Scholarship</option>
                    <option value="Stipend">Stipend Available</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i data-lucide="map-pin"></i> Location
                </label>
                <select class="filter-select" id="filterLocation">
                    <option value="all">All Locations</option>
                    <option value="Virtual">Virtual/Online</option>
                    <option value="National">National</option>
                    <option value="Local">Local/Regional</option>
                    <option value="International">International</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i data-lucide="calendar"></i> Duration
                </label>
                <select class="filter-select" id="filterDuration">
                    <option value="all">Any Duration</option>
                    <option value="Summer">Summer Program</option>
                    <option value="Academic Year">Academic Year</option>
                    <option value="Short Term">Short Term (1-4 weeks)</option>
                    <option value="Long Term">Long Term (3+ months)</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label class="filter-label">
                    <i data-lucide="target"></i> Match Score
                </label>
                <select class="filter-select" id="filterMatch">
                    <option value="all">Any Match</option>
                    <option value="90">90%+ Match</option>
                    <option value="80">80%+ Match</option>
                    <option value="70">70%+ Match</option>
                    <option value="eligible">Eligible Only</option>
                </select>
            </div>
            
            <!-- Clear Filters Button -->
            <button class="btn btn-secondary btn-full mt-2" onclick="clearFilters()">
                <i data-lucide="refresh-ccw"></i> Clear Filters
            </button>
            
            <!-- "Add an Ally" Button -->
            <button class="btn btn-primary btn-full mt-4" onclick="window.location.href='submission.html'">
                <i data-lucide="plus-circle"></i> Add an Ally
            </button>
            
            <!-- Daily AI Tip -->
            <div class="daily-tip">
                <h4 class="flex items-center gap-2">
                    <i data-lucide="lightbulb"></i> Daily AI Tip
                </h4>
                <p class="text-dim mt-2" id="dailyTip">
                    Start applications early! Most competitive programs have deadlines 6-9 months in advance.
                </p>
                <button class="btn btn-secondary btn-full mt-2" onclick="newTip()">
                    <i data-lucide="refresh-cw"></i> New Tip
                </button>
            </div>
        </aside>

        <!-- ========== MIDDLE DIRECTORY SECTION ========== -->
        <section class="directory-section">
            <!-- Directory Header -->
            <div class="directory-header">
                <div>
                    <h2><i data-lucide="layout-grid"></i> Opportunity Directory</h2>
                    <p class="text-dim" id="resultCount">Loading opportunities...</p>
                </div>
                
                <div class="search-box">
                    <i data-lucide="search" class="search-icon"></i>
                    <input type="text" class="search-input" id="searchInput" 
                           placeholder="Search opportunities, organizations, or keywords...">
                </div>
            </div>

            <!-- Stats Bar -->
            <div class="flex gap-4 mb-6 flex-wrap">
                <div class="spotlight-card" style="padding: 1rem;">
                    <div class="flex items-center gap-2">
                        <i data-lucide="database" style="color: var(--primary);"></i>
                        <div>
                            <div class="text-dim">Total Opportunities</div>
                            <div class="font-bold text-xl" id="totalCount">102</div>
                        </div>
                    </div>
                </div>
                <div class="spotlight-card" style="padding: 1rem;">
                    <div class="flex items-center gap-2">
                        <i data-lucide="check-circle" style="color: var(--success);"></i>
                        <div>
                            <div class="text-dim">Eligible for You</div>
                            <div class="font-bold text-xl" id="eligibleCount">0</div>
                        </div>
                    </div>
                </div>
                <div class="spotlight-card" style="padding: 1rem;">
                    <div class="flex items-center gap-2">
                        <i data-lucide="bookmark" style="color: var(--warning);"></i>
                        <div>
                            <div class="text-dim">Bookmarked</div>
                            <div class="font-bold text-xl" id="bookmarkCount">0</div>
                        </div>
                    </div>
                </div>
                <div class="spotlight-card" style="padding: 1rem;">
                    <div class="flex items-center gap-2">
                        <i data-lucide="target" style="color: var(--info);"></i>
                        <div>
                            <div class="text-dim">Avg. Match Score</div>
                            <div class="font-bold text-xl" id="avgMatch">0%</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Opportunity Grid -->
            <div class="directory-grid" id="directoryGrid">
                <!-- Opportunity cards will be loaded by JavaScript -->
            </div>

            <!-- No Results Message -->
            <div id="noResults" class="hidden text-center p-8">
                <i data-lucide="search-x" style="width: 4rem; height: 4rem; color: var(--text-dim); margin-bottom: 1rem;"></i>
                <h3>No Opportunities Found</h3>
                <p class="text-dim">Try adjusting your filters or search terms.</p>
                <button class="btn btn-secondary mt-4" onclick="clearFilters()">
                    <i data-lucide="refresh-ccw"></i> Clear All Filters
                </button>
            </div>

            <!-- Loading Indicator -->
            <div id="loadingIndicator" class="text-center p-8">
                <i data-lucide="loader" style="width: 2rem; height: 2rem; color: var(--primary); animation: spin 1s linear infinite;"></i>
                <p class="text-dim mt-2">Loading opportunities...</p>
            </div>
        </section>

        <!-- ========== RIGHT AI CHAT PANEL (ALWAYS VISIBLE) ========== -->
        <aside class="ai-panel">
            <div class="ai-header">
                <div class="flex items-center gap-2">
                    <i data-lucide="bot" style="color: var(--primary);"></i>
                    <h3>Zeus AI Counselor</h3>
                </div>
            </div>
            
            <div class="ai-messages" id="aiMessages">
                <div class="message ai">
                    <strong>Zeus:</strong> Welcome to your dashboard! I can help you find opportunities, answer application questions, or provide advice. What would you like to know?
                </div>
            </div>
            
            <div class="ai-input">
                <input type="text" id="aiInput" placeholder="Ask about opportunities, applications, deadlines..."
                       onkeypress="if(event.key === 'Enter') sendAIMessage()">
                <button class="btn btn-primary" onclick="sendAIMessage()">
                    <i data-lucide="send"></i>
                </button>
            </div>
        </aside>
    </main>

    <!-- ========== FOOTER ========== -->
    <footer style="border-top: 1px solid var(--border-color); margin-top: 4rem; padding: 3rem 0; background: var(--bg-secondary);">
        <div class="container">
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
                <!-- About Section -->
                <div>
                    <h4 style="margin-bottom: 1rem; font-weight: 600;">About Student Atlas</h4>
                    <p class="text-dim" style="font-size: 0.95rem; line-height: 1.6;">
                        Student Atlas connects students with 80+ transformative opportunities across STEM, Arts, Humanitarian, Civics, and Scholarships sectors. Our mission is to empower students to discover their perfect career match.
                    </p>
                </div>
                
                <!-- Quick Links -->
                <div>
                    <h4 style="margin-bottom: 1rem; font-weight: 600;">Quick Links</h4>
                    <ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-wrap: wrap; gap: 1rem;">
                        <li>
                            <a href="dashboard.html" class="text-dim" style="text-decoration: none; transition: color 0.3s;">
                                <i data-lucide="grid" style="width: 1rem; height: 1rem; margin-right: 0.5rem; vertical-align: middle;"></i>
                                Dashboard
                            </a>
                        </li>
                        <li>
                            <a href="profile.html" class="text-dim" style="text-decoration: none; transition: color 0.3s;">
                                <i data-lucide="user" style="width: 1rem; height: 1rem; margin-right: 0.5rem; vertical-align: middle;"></i>
                                My Profile
                            </a>
                        </li>
                        <li>
                            <a href="submission.html" class="text-dim" style="text-decoration: none; transition: color 0.3s;">
                                <i data-lucide="plus-circle" style="width: 1rem; height: 1rem; margin-right: 0.5rem; vertical-align: middle;"></i>
                                Suggest Resource
                            </a>
                        </li>
                        <li>
                            <a href="references.html" class="text-dim" style="text-decoration: none; transition: color 0.3s;">
                                <i data-lucide="book-open" style="width: 1rem; height: 1rem; margin-right: 0.5rem; vertical-align: middle;"></i>
                                Reference Page
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Divider -->
            <div style="height: 1px; background: var(--border-color); margin: 2rem 0;"></div>
            
            <!-- Bottom Section -->
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <p class="text-dim" style="margin: 0; font-size: 0.9rem;">
                        &copy; 2026 Student Atlas. All rights reserved.
                    </p>
                    <p class="text-dim" style="margin: 0.25rem 0 0 0; font-size: 0.85rem;">
                        Technology Student Association (TSA) Webmaster Chapter Entry
                    </p>
                </div>
                <div style="display: flex; gap: 1.5rem; font-size: 0.9rem;">
                    <span class="text-dim">v1.0.0</span>
                    <span class="text-dim">•</span>
                    <span class="text-dim">Last Updated: January 2026</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- ========== OPPORTUNITY DETAIL MODAL ========== -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <!-- Content will be filled by JavaScript -->
        </div>
    </div>

    <!-- ========== READER OVERLAY ========== -->
    <div id="readerOverlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(10,10,10,0.98); color:#fff; z-index:20000; overflow:auto; padding:2rem;">
        <button onclick="closeReaderOverlay()" style="position:absolute; top:1rem; right:2rem; font-size:2rem; background:none; color:#fff; border:none; cursor:pointer;">&times;</button>
        <button onclick="readAloud()" style="display:block; margin:1.5rem auto 1.5rem 0; font-size:1.2rem; padding:0.75rem 2rem; background:#10b981; color:#000; border:none; border-radius:8px; cursor:pointer; position:relative; z-index:2;">Read Aloud</button>
        <h2 style="font-size:2.5rem; margin-bottom:1.5rem;">Reader Mode</h2>
        <div id="readerContent" style="font-size:1.5rem; line-height:2; max-width:900px; margin:auto;"></div>
    </div>

    <!-- ========== JAVASCRIPT ========== -->
    <script src="js/data.js"></script>
    <script src="js/main.js"></script>
    <script src="js/zeus-ai.js"></script>
    <script src="js/compromise-nlp.js"></script>
    
    <script>
        // Dashboard-specific functionality
        let filteredOpportunities = [];
        let currentFilters = {
            search: '',
            cluster: 'all',
            cost: 'all',
            location: 'all',
            duration: 'all',
            match: 'all'
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loading...');
            
            // Initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Load student profile and update displays
            loadDashboardProfile();
            
            // Wait for data to load, then display opportunities
            setTimeout(() => {
                loadDashboardOpportunities();
            }, 100);
            
            // Set up daily tip
            setDailyTip();
            
            // Set up event listeners
            setupDashboardListeners();
            
            // Apply saved filters if any
            applySavedFilters();
        });

        // ============================================
        // PROFILE MANAGEMENT
        // ============================================

        function loadDashboardProfile() {
            const profile = StudentAtlas.getStudentProfile();
            console.log('Loading profile:', profile);
            
            if (profile) {
                // Update sidebar
                document.getElementById('sidebarGrade').textContent = profile.grade || '11th Grade';
                document.getElementById('sidebarGPA').textContent = profile.gpa || '3.8';
                document.getElementById('sidebarCluster').textContent = profile.clusterMatch || 'STEM';
                
                // Update header - SHOW USERNAME NOT GRADE
                const userName = profile.username || 'TSA Student 2026';
                document.getElementById('userName').textContent = userName;
                
                // Set cluster filter to match profile
                document.getElementById('filterCluster').value = profile.clusterMatch || 'all';
                currentFilters.cluster = profile.clusterMatch || 'all';
            }
            
            // Update bookmark count
            updateBookmarkCount();
        }

        // ============================================
        // OPPORTUNITIES LOADING & DISPLAY
        // ============================================

        function loadDashboardOpportunities() {
            console.log('Loading opportunities...');
            
            // Show loading indicator
            document.getElementById('loadingIndicator').classList.remove('hidden');
            document.getElementById('directoryGrid').innerHTML = '';
            
            // Check if opportunities data is loaded
            if (!window.opportunitiesData || window.opportunitiesData.length === 0) {
                console.error('Opportunities data not loaded!');
                document.getElementById('loadingIndicator').innerHTML = `
                    <i data-lucide="alert-circle" style="width: 3rem; height: 3rem; color: var(--error);"></i>
                    <p class="text-dim mt-2">Error loading opportunities. Please refresh the page.</p>
                `;
                lucide.createIcons();
                return;
            }
            
            console.log(`Loaded ${window.opportunitiesData.length} opportunities`);
            
            // Calculate match scores for all opportunities
            StudentAtlas.calculateAllMatchScores();
            
            // Apply filters and display
            filterOpportunities();
            
            // Hide loading indicator
            document.getElementById('loadingIndicator').classList.add('hidden');
        }

        function displayOpportunities() {
            const grid = document.getElementById('directoryGrid');
            const noResults = document.getElementById('noResults');
            
            if (filteredOpportunities.length === 0) {
                grid.classList.add('hidden');
                noResults.classList.remove('hidden');
                lucide.createIcons();
                return;
            }
            
            grid.classList.remove('hidden');
            noResults.classList.add('hidden');
            
            // Sort by match score (highest first)
            const sortedOpportunities = [...filteredOpportunities].sort((a, b) => {
                const scoreA = StudentAtlas.getOpportunityMatchScore(a.id);
                const scoreB = StudentAtlas.getOpportunityMatchScore(b.id);
                return scoreB - scoreA;
            });
            
            // Generate cards
            grid.innerHTML = sortedOpportunities.map(opportunity => 
                StudentAtlas.formatOpportunityCard(opportunity)
            ).join('');
            
            // Re-initialize Lucide icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Update stats
            updateStats();
        }

        // ============================================
        // FILTERING
        // ============================================

        function filterOpportunities() {
            if (!window.opportunitiesData) {
                console.error('No opportunities data available');
                return;
            }
            
            // Get filter values
            currentFilters = {
                search: document.getElementById('searchInput').value.toLowerCase(),
                cluster: document.getElementById('filterCluster').value,
                cost: document.getElementById('filterCost').value,
                location: document.getElementById('filterLocation').value,
                duration: document.getElementById('filterDuration').value,
                match: document.getElementById('filterMatch').value
            };
            
            // Save filters
            localStorage.setItem('dashboardFilters', JSON.stringify(currentFilters));
            
            // Apply filters
            filteredOpportunities = window.opportunitiesData.filter(opp => {
                // Search term filter
                if (currentFilters.search && !(
                    opp.title.toLowerCase().includes(currentFilters.search) ||
                    opp.organization.toLowerCase().includes(currentFilters.search) ||
                    opp.description.toLowerCase().includes(currentFilters.search) ||
                    opp.cluster.toLowerCase().includes(currentFilters.search)
                )) {
                    return false;
                }
                
                // Cluster filter
                if (currentFilters.cluster !== 'all' && opp.cluster !== currentFilters.cluster) {
                    return false;
                }
                
                // Cost filter
                if (currentFilters.cost !== 'all') {
                    if (currentFilters.cost === 'Free' && opp.cost !== 'Free') return false;
                    if (currentFilters.cost === 'Paid' && opp.cost === 'Free') return false;
                    if (currentFilters.cost === 'Scholarship' && !opp.cost.toLowerCase().includes('scholarship')) return false;
                    if (currentFilters.cost === 'Stipend' && !opp.cost.toLowerCase().includes('stipend')) return false;
                }
                
                // Location filter
                if (currentFilters.location !== 'all') {
                    const oppLocation = opp.location.toLowerCase();
                    if (currentFilters.location === 'Virtual' && !oppLocation.includes('virtual')) return false;
                    if (currentFilters.location === 'National' && oppLocation !== 'national') return false;
                    if (currentFilters.location === 'Local' && !['local', 'regional'].some(term => 
                        oppLocation.includes(term))) return false;
                    if (currentFilters.location === 'International' && !oppLocation.includes('international')) return false;
                }
                
                // Duration filter
                if (currentFilters.duration !== 'all') {
                    if (currentFilters.duration === 'Summer' && !opp.duration.toLowerCase().includes('summer')) return false;
                    if (currentFilters.duration === 'Academic Year' && !opp.duration.toLowerCase().includes('academic')) return false;
                    if (currentFilters.duration === 'Short Term' && !opp.duration.toLowerCase().includes('short')) return false;
                    if (currentFilters.duration === 'Long Term' && !opp.duration.toLowerCase().includes('long')) return false;
                }
                
                // Match score filter
                if (currentFilters.match !== 'all') {
                    const matchScore = StudentAtlas.getOpportunityMatchScore(opp.id);
                    if (currentFilters.match === 'eligible' && matchScore < 70) return false;
                    if (Number(currentFilters.match) > 0 && matchScore < Number(currentFilters.match)) return false;
                }
                
                return true;
            });
            
            displayOpportunities();
        }

        function applySavedFilters() {
            const saved = localStorage.getItem('dashboardFilters');
            if (saved) {
                try {
                    const filters = JSON.parse(saved);
                    
                    document.getElementById('searchInput').value = filters.search || '';
                    document.getElementById('filterCluster').value = filters.cluster || 'all';
                    document.getElementById('filterCost').value = filters.cost || 'all';
                    document.getElementById('filterLocation').value = filters.location || 'all';
                    document.getElementById('filterDuration').value = filters.duration || 'all';
                    document.getElementById('filterMatch').value = filters.match || 'all';
                    
                    currentFilters = filters;
                } catch (e) {
                    console.error('Error loading saved filters:', e);
                }
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterCluster').value = 'all';
            document.getElementById('filterCost').value = 'all';
            document.getElementById('filterLocation').value = 'all';
            document.getElementById('filterDuration').value = 'all';
            document.getElementById('filterMatch').value = 'all';
            
            currentFilters = {
                search: '',
                cluster: 'all',
                cost: 'all',
                location: 'all',
                duration: 'all',
                match: 'all'
            };
            
            localStorage.removeItem('dashboardFilters');
            
            filterOpportunities();
            StudentAtlas.showNotification('Filters cleared', 'info');
        }

        // ============================================
        // STATISTICS & UPDATES
        // ============================================

        function updateStats() {
            const total = window.opportunitiesData?.length || 0;
            const filtered = filteredOpportunities.length;
            const eligible = filteredOpportunities.filter(opp => 
                StudentAtlas.getOpportunityMatchScore(opp.id) >= 70
            ).length;
            
            // Calculate average match score
            let avgMatch = 0;
            if (filtered > 0) {
                const totalScore = filteredOpportunities.reduce((sum, opp) => 
                    sum + StudentAtlas.getOpportunityMatchScore(opp.id), 0
                );
                avgMatch = Math.round(totalScore / filtered);
            }
            
            // Update DOM
            document.getElementById('totalCount').textContent = total;
            document.getElementById('eligibleCount').textContent = eligible;
            document.getElementById('avgMatch').textContent = avgMatch + '%';
            document.getElementById('resultCount').textContent = 
                `Showing ${filtered} of ${total} opportunities`;
            
            // Update bookmark count
            updateBookmarkCount();
        }

        function updateBookmarkCount() {
            const bookmarks = StudentAtlas.state.bookmarks.length;
            document.getElementById('bookmarkCount').textContent = bookmarks;
        }

        function toggleBookmark(event, opportunityId) {
            event.stopPropagation();
            StudentAtlas.toggleBookmark(opportunityId);
        }

        function updateBookmarkUI(opportunityId) {
            // Update bookmark button in grid
            const card = document.querySelector(`.opportunity-card[data-id="${opportunityId}"]`);
            if (card) {
                const btn = card.querySelector('.save-btn');
                const isBookmarked = StudentAtlas.isBookmarked(opportunityId);
                
                if (btn) {
                    btn.classList.toggle('saved', isBookmarked);
                    const icon = btn.querySelector('i, svg');
                    if (icon) {
                        // Replace the icon with a new i element
                        const newIcon = document.createElement('i');
                        newIcon.setAttribute('data-lucide', isBookmarked ? 'bookmark' : 'bookmark-plus');
                        icon.parentNode.replaceChild(newIcon, icon);
                        // Re-initialize Lucide icons
                        if (typeof lucide !== 'undefined') {
                            lucide.createIcons();
                        }
                    }
                }
            }
            
            // Update stats
            updateBookmarkCount();
        }

        // ============================================
        // DAILY TIPS
        // ============================================

        function setDailyTip() {
            const tips = [
                "Start applications early! Most competitive programs have deadlines 6-9 months in advance.",
                "Customize your essays for each application. Generic essays are easy to spot.",
                "Ask for recommendation letters at least one month before deadlines.",
                "Follow up on applications with a polite email if you haven't heard back in 4-6 weeks.",
                "Practice interview questions with a friend or family member.",
                "Keep a spreadsheet to track application deadlines and requirements.",
                "Save all application materials in a cloud folder for easy access.",
                "Attend virtual info sessions to learn more about programs and ask questions.",
                "Highlight specific skills and experiences that match each opportunity's requirements.",
                "Proofread everything! Typos and errors create a negative impression."
            ];
            
            // Get a different tip each day
            const today = new Date().getDate();
            const randomTip = tips[today % tips.length];
            document.getElementById('dailyTip').textContent = randomTip;
        }

        function newTip() {
            setDailyTip();
            StudentAtlas.showNotification('New tip loaded!', 'info');
        }

        // ============================================
        // DETAIL VIEW MODAL
        // ============================================

        function viewOpportunityDetails(opportunityId) {
            const opportunity = window.opportunitiesData?.find(opp => opp.id === opportunityId);
            if (!opportunity) return;
            
            const modal = document.getElementById('detailModal');
            const content = modal.querySelector('.modal-content');
            const matchScore = StudentAtlas.getOpportunityMatchScore(opportunityId);
            const isBookmarked = StudentAtlas.isBookmarked(opportunityId);
            const matchColor = StudentAtlas.getClusterColor(opportunity.cluster);
            
            content.innerHTML = `
                <button class="modal-close-btn" onclick="closeDetailModal()">×</button>
                
                <div class="flex items-start gap-4 mb-4">
                    <div style="width: 4rem; height: 4rem; background: ${matchColor}20; 
                             border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                        <i data-lucide="briefcase" style="width: 2rem; height: 2rem; color: ${matchColor};"></i>
                    </div>
                    <div>
                        <h2>${opportunity.title}</h2>
                        <p class="text-dim">${opportunity.organization}</p>
                        <span class="match-badge" style="background: ${matchColor}">
                            ${matchScore}% Match
                        </span>
                        <span class="match-badge" style="background: ${StudentAtlas.getClusterColor(opportunity.cluster)}; margin-left: 0.5rem;">
                            ${opportunity.cluster}
                        </span>
                    </div>
                </div>
                    
                    <div class="grid grid-cols-2 gap-4 mb-4" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                        <div class="spotlight-card">
                            <h4><i data-lucide="map-pin"></i> Location</h4>
                            <p>${opportunity.location}</p>
                        </div>
                        <div class="spotlight-card">
                            <h4><i data-lucide="dollar-sign"></i> Cost</h4>
                            <p>${opportunity.cost}</p>
                        </div>
                        <div class="spotlight-card">
                            <h4><i data-lucide="calendar"></i> Duration</h4>
                            <p>${opportunity.duration}</p>
                        </div>
                        <div class="spotlight-card">
                            <h4><i data-lucide="users"></i> Eligible Grades</h4>
                            <p>${opportunity.eligibility.grades.map(g => g + (g === 1 ? 'st' : g === 2 ? 'nd' : g === 3 ? 'rd' : 'th')).join(', ')}</p>
                        </div>
                    </div>
                    
                    <div class="spotlight-card mb-4">
                        <h4><i data-lucide="file-text"></i> Description</h4>
                        <p>${opportunity.description}</p>
                    </div>
                    
                    <div class="spotlight-card mb-4">
                        <h4><i data-lucide="check-circle"></i> Eligibility Requirements</h4>
                        <ul style="list-style: none; padding: 0;">
                            <li class="detail-row"><i data-lucide="star"></i> Minimum GPA: ${opportunity.eligibility.minGPA}</li>
                            <li class="detail-row"><i data-lucide="graduation-cap"></i> Grades: ${opportunity.eligibility.grades.map(g => g + 'th').join(', ')}</li>
                            <li class="detail-row"><i data-lucide="target"></i> Skills: ${opportunity.eligibility.skills.join(', ')}</li>
                            ${opportunity.eligibility.hoursRequired > 0 ? 
                                `<li class="detail-row"><i data-lucide="clock"></i> Service Hours: ${opportunity.eligibility.hoursRequired}+ required</li>` : ''}
                        </ul>
                    </div>
                    
                    <div class="flex gap-2">
                        <button class="btn btn-primary" style="flex: 2;" 
                                onclick="window.open('${opportunity.link}', '_blank')"
                                ${matchScore < 70 ? 'disabled style="opacity: 0.5;"' : ''}>
                            <i data-lucide="external-link"></i> 
                            ${matchScore < 70 ? 'Review Eligibility First' : 'Apply Now'}
                        </button>
                        <button class="btn btn-secondary" style="flex: 1;" 
                                onclick="toggleBookmarkDetail(${opportunity.id})">
                            <i data-lucide="${isBookmarked ? 'bookmark-minus' : 'bookmark-plus'}"></i>
                            ${isBookmarked ? 'Remove Bookmark' : 'Bookmark'}
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
            
            // Re-initialize icons
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        function toggleBookmarkDetail(opportunityId) {
            StudentAtlas.toggleBookmark(opportunityId);
            
            // Update modal button
            const modal = document.getElementById('detailModal');
            const btn = modal.querySelector('.btn-secondary');
            const icon = btn.querySelector('i');
            const isBookmarked = StudentAtlas.isBookmarked(opportunityId);
            
            btn.innerHTML = `
                <i data-lucide="${isBookmarked ? 'bookmark-minus' : 'bookmark-plus'}"></i>
                ${isBookmarked ? 'Remove Bookmark' : 'Bookmark'}
            `;
            
            // Update grid
            updateBookmarkUI(opportunityId);
            
            // Re-initialize icon
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // ============================================
        // AI CHAT FUNCTIONS
        // ============================================

        function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message
            const messagesDiv = document.getElementById('aiMessages');
            const userMsg = document.createElement('div');
            userMsg.className = 'message user';
            userMsg.innerHTML = `<strong>You:</strong> ${message}`;
            messagesDiv.appendChild(userMsg);
            
            // Clear input
            input.value = '';
            
            // Add typing indicator
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message ai typing';
            typingDiv.innerHTML = `<strong>Zeus:</strong> <span class="typing-indicator">Typing...</span>`;
            messagesDiv.appendChild(typingDiv);
            
            // Scroll to bottom
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // Get AI response with random delay
            const delay = 500 + Math.random() * 1000; // 500-1500ms
            setTimeout(() => {
                // Remove typing indicator
                messagesDiv.removeChild(typingDiv);
                
                const aiMsg = document.createElement('div');
                aiMsg.className = 'message ai';
                aiMsg.innerHTML = `<strong>Zeus:</strong> ${StudentAtlas.getZeusResponse(message)}`;
                messagesDiv.appendChild(aiMsg);
                
                // Scroll to bottom
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                // Re-initialize icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, delay);
        }

        // ============================================
        // EVENT LISTENERS
        // ============================================

        function setupDashboardListeners() {
            // Filter event listeners
            document.getElementById('searchInput').addEventListener('input', debounce(filterOpportunities, 300));
            document.getElementById('filterCluster').addEventListener('change', filterOpportunities);
            document.getElementById('filterCost').addEventListener('change', filterOpportunities);
            document.getElementById('filterLocation').addEventListener('change', filterOpportunities);
            document.getElementById('filterDuration').addEventListener('change', filterOpportunities);
            document.getElementById('filterMatch').addEventListener('change', filterOpportunities);
            
            // AI chat input
            const aiInput = document.getElementById('aiInput');
            if (aiInput) {
                aiInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') sendAIMessage();
                });
            }
            
            // Listen for bookmark changes from other tabs
            window.addEventListener('storage', function(e) {
                if (e.key === 'studentAtlasBookmarks') {
                    // Reload bookmarks state
                    StudentAtlas.loadBookmarks();
                    // Update bookmark count
                    updateBookmarkCount();
                    // Refresh the grid to update bookmark icons
                    filterOpportunities();
                }
            });
            
            // Close modals on escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeDetailModal();
                }
            });
        }

        function toggleProfileMenu() {
            const menu = document.getElementById('profileMenu');
            menu.classList.toggle('hidden');
        }

        function logout() {
            StudentAtlas.clearAllData();
            window.location.href = 'index.html';
        }

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Reader Overlay functions
        function openReaderOverlay() {
            var main = document.getElementById('main-content');
            var content = main ? main.innerText : document.body.innerText;
            document.getElementById('readerContent').innerText = content;
            document.getElementById('readerOverlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }
        function closeReaderOverlay() {
            document.getElementById('readerOverlay').style.display = 'none';
            document.body.style.overflow = '';
            if (window.speechSynthesis) window.speechSynthesis.cancel();
        }
        function readAloud() {
            if (!window.speechSynthesis) return;
            var text = document.getElementById('readerContent').innerText;
            var utter = new SpeechSynthesisUtterance(text);
            utter.rate = 1;
            utter.pitch = 1;
            utter.volume = 1;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utter);
        }
        window.addEventListener('DOMContentLoaded', function() {
            var readerBtn = document.getElementById('screenReader');
            if (readerBtn) {
                readerBtn.onclick = openReaderOverlay;
            }
        });

        // Make functions available globally
        window.filterOpportunities = filterOpportunities;
        window.clearFilters = clearFilters;
        window.newTip = newTip;
        window.viewOpportunityDetails = viewOpportunityDetails;
        window.closeDetailModal = closeDetailModal;
        window.toggleBookmarkDetail = toggleBookmarkDetail;
        window.sendAIMessage = sendAIMessage;
        window.toggleProfileMenu = toggleProfileMenu;
        window.logout = logout;
        window.updateBookmarkUI = updateBookmarkUI;
    </script>
</body>
</html>